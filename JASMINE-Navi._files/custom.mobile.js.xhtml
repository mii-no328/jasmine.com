/*
 * custom.mobile.js
 *
 * 著作権  ：Copyright Japan System Techniques Co., Ltd. All Rights Reserved.
 * 会社名  ：日本システム技術株式会社
 */

// ---------------------------------------------------------
// グローバル変数の定義
// ---------------------------------------------------------

// MobileConst.javaと同じ
var MobileConst = {
    'Prefix': 'pmPage',
    'ParamKey': 'keyList'
};


// ---------------------------------------------------------
// 画面初期表示時の処理メソッド
// ---------------------------------------------------------


// ---------------------------------------------------------
// 通常メソッド
// ---------------------------------------------------------

/**
 * 同期遷移の場合、イベント発火コンポーネントのid（javax.faces.source）が送信されないため、別途リクエストに追加する。
 * 引数には原則として this を渡してください。
 * ただし、発火する要素がアクションを発生させる要素と異なる場合（メニューなど）にコンポーネントのidを指定します。
 * これは同期遷移時のリクエストログの出力に必要な情報です。
 * （cf. RxRestoreViewPhaseListener#afterPhase）
 * 
 * @param {String|HTML要素} source
 */
function syncTransition(source) {
    var component = (typeof (source) === 'string') ? $(PrimeFaces.escapeClientId(source)) : $(source);
    var id = component.attr('id');
    if (id) {
        var splitId = id.split(':');
        var form = splitId[0] + ':' + splitId[1];
        // 独自のキー（rx.sync.source）にidを設定してリクエストに追加する。
        PrimeFaces.addSubmitParam(form, {'rx.sync.source': id});
    }
    // 
    UtilMobileLoadingView.showLodingIcon();
}

/**
 * 全画面のロックとローディングアイコン用のクラス。
 *
 */
UtilMobileLoadingView = {
    /**
     * 全画面のロック解除とローディングアイコンを非表示にする。<br>
     *
     */
    hideLodingIcon: function () {
        // 画面ロックを解除し、ローディングアイコンを非表示にする。
        $('#layer').html('.ui-mobile-viewport.ui-overlay-a::before{}');
        $.mobile.loading('hide');
    },
    /**
     * 全画面のロック解除とローディングアイコンを非表示にする。<br>
     * 指定された時間だけ、ロック解除とアイコンの非表示を遅延する。
     *
     * @param {int} delayTime ロック解除の遅延時間（ミリ秒）
     */
    hideDelayLodingIcon: function (delayTime) {
        // 
        $('body').css('display:none');
        // 遅延時間経過後に、画面ロックを解除し、ローディングアイコンを非表示にする。
        setTimeout(function(){ 
            $('body').css('display:block');
            $('#layer').html('.ui-mobile-viewport.ui-overlay-a::before{}'); 
            $.mobile.loading('hide');
        }, delayTime);
    },
    /**
     * 全画面のロックとローディングアイコンを表示にする。<br>
     *
     */
    showLodingIcon: function () {
        // ローディングアイコンの表示・非表示を判定する。
        if (showAjaxLoadingFlg) {
            // 画面をロック状態にして、ローディングアイコンを表示にする。
            $.mobile.loading('show');
            $('#layer').html('.ui-mobile-viewport.ui-overlay-a::before{content:"";background-color:rgba(0,0,0,0.1);position:fixed;top:0;right:0;bottom:0;left:0;z-index:9999999;}');
        }
        // 
        showAjaxLoadingFlg = true;
    }
};


/**
 * 同一画面内のページ遷移を真似する。
 * 2015/12/18 oncomplete時に遷移(切替)する場合、validationFailedで遷移するか判定する
 * (参考)primefaces_user_guide_5_2.pdf　p.528　oncomplete(xhr, status, args)　
 * 
 * @param {String} to 遷移先DIVのID
 */
function navigateMobile(to) {
    if (typeof to === 'undefined') {
        return;
    }
    // 遷移用のDIVを全て隠し、遷移先のDIVのみ表示する
    $('.mobile-navi-div').hide();
    $(to).show();
}


// ---------------------------------------------------------
// PrimeFacesのメソッドハック
// ---------------------------------------------------------

// PrimeFaces の PrimeFaces.cw を退避
var pfCw = PrimeFaces.cw;
// PrimeFaces の PrimeFaces.ajax.Utils.updateElement を退避
var pfUpdateElement = PrimeFaces.ajax.Utils.updateElement;

/**
 * PrimeFaces mobileのバグ対応。
 * 関連ISSUE：https://code.google.com/p/primefaces/issues/detail?id=7717
 * 
 * @param {String} name Widget名（コンストラクタ名）
 * @param {String} id widgetVar
 * @param {Object} options オプション（設定値）
 * @param {String} resource リソース名
 */
PrimeFaces.cw = function (name, id, options, resource) {
    resource = resource || name.toLowerCase();
    // 退避したオリジナルメソッドをコール
    pfCw.apply(this, [name, id, options, resource]);
};

/**
 * update をハックし、ビュー全体が更新される前に、pollが存在すれば停止する。
 * 
 * @param {String} id updateするコンポーネントのID
 * @param {String} content updateする内容（HTML）
 * @param {XMLHttpRequest} xhr XMLHTTPリクエスト
 */
PrimeFaces.ajax.Utils.updateElement = function (id, content, xhr) {
    if (id === PrimeFaces.VIEW_ROOT && PrimeFaces.widgets['poll']) {
        PF('poll').stop();
    }
    // 退避したオリジナルメソッドをコール
    pfUpdateElement.apply(this, arguments);
};

/**
 * ダイアログの非表示をハックし、closeイベントを発火させる。
 * モバイル版ではcloseイベントが発火しないため。
 */
PrimeFaces.widget.Dialog.prototype.hide = function () {
    // closeイベントを発火する
    if (this.cfg.behaviors) {
        var event = this.cfg.behaviors.close;
        if (event) {
            event.call(this);
        }
    }
    this.popupElement.popup('close');
};

/* global PrimeFaces */
// rxFunc定義があれば、オブジェクトを追加する
//TODO 一か所で定義するのが望ましい。。。mobileCalendarで使用
PrimeFaces.rxFunc = $.extend(PrimeFaces.rxFunc, {
    changeDateTime: function (id) {
        //onblur時に実行する
        //widgetVarを渡す
        var dateId = this.getInputId('rxDate_' + id);
        var timeId = this.getInputId('rxTime_' + id);
        //送信用
        var dateTimeId = this.getInputId('rxDateTime_' + id);

        var strDate = this.getObj(dateId).value;
        var strTime = this.getObj(timeId).value;
        //pattern="yyyy-MM-dd HH:mm"
        var strDateTime = strDate + ' ' + strTime;

        if (strDate === '' || strTime === '') {
            //片方が''なら送信する値を''する
            strDateTime = '';
        }
        this.getObj(dateTimeId).value = strDateTime;
    },
    getInputId: function (widgetVar) {
        //widgetVarから取得できるidに"_input"を付与したものが対象のid
        return PF(widgetVar).id + '_input';
    },
    getObj: function (id) {
        return document.getElementById(id);
    }
});
